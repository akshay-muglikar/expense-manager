<!-- Toggle Menu -->

<div class="bill-container">
  <div class="toggle-menu mb-3">
    <button mat-button class="btn" [class.btn-primary]="activeTab === 'bill'" [class.btn-secondary]="activeTab !== 'bill'" (click)="activeTab = 'bill'">
      <mat-icon>receipt</mat-icon>
      <span translate>Bill Entry</span>
    </button>
    <button mat-button class="btn" [class.btn-primary]="activeTab === 'history'" [class.btn-secondary]="activeTab !== 'history'" (click)="activeTab = 'history'">
      <mat-icon>history</mat-icon>
      <span translate>History</span>
    </button>
  </div>

  <div *ngIf="activeTab === 'bill'" class="bill-form-container">
  <div class="bill-form">
    <div class="bill-header">
      <h2 translate>New Bill</h2>
      <span class="text-secondary">{{bill.billDate?.toLocaleString()}}</span>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label translate>Customer Name</label>
        <input [(ngModel)]="bill.name" style="width: 300px; padding: 5px;" placeholder="Enter customer name">
      </div>
      
      <div class="form-group">
        <label translate>Mobile Number</label>
        <input [(ngModel)]="bill.mobile" style="width: 300px; padding: 5px;" placeholder="Enter mobile number">
      </div>
    </div>

    <div class="items-table">
      <div class="">
        <table>
          <thead>
            <tr>
              <th translate>Action</th>
              <th translate>Item</th>
              <th translate>Rate</th>
              <th translate>Qty</th>
              <th translate>Price</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of billItems; let i = index">
              <td>
                <button mat-icon-button class="btn-secondary" (click)="removeItem(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
              <td>
                <ng-select [(ngModel)]="billItems[i].itemId" 
                          [items]="items" 
                          bindLabel="name" 
                          bindValue="id"
                          placeholder="Select item"
                          (change)="setItemProps(i)">
                </ng-select>
              </td>
              <td>                  <input type="text" [(ngModel)]="billItems[i].amount" placeholder="Price" (ngModelChange)="updateQty(i)">
          </td>
              <td>
                <input type="text" [(ngModel)]="billItems[i].quantity" placeholder="Quantity" (ngModelChange)="updateQty(i)">
              </td>
              <td>
                {{billItems[i].itemTotal | number:'1.0-0'}}
                </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-row mt-3">
      <button mat-raised-button class="btn btn-secondary" (click)="addIteminBill()">
        <mat-icon>add</mat-icon> {{'Add Item' | translate}}
      </button>
    
    </div>
    <div class="form-row mt-3">
      <input type="text" style="width: 300px;" placeholder="Scan/Enter product code" class="form-control mb-2" [(ngModel)]="scannedCode" id="barcodeinput" (keydown.enter)="ScanItem()">
    </div>
    <div class="form-row mt-3">
      <!-- open modal -->
      <button mat-raised-button  class="btn btn-secondary btn-inventory" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <mat-icon>add</mat-icon>Add new Inventory
      </button>
    </div>

    <div class="bill-summary">
      <div class="summary-details">
        <div class="summary-item">
          <div class="label" translate>Payment Mode</div>
          <select [(ngModel)]="bill.paymentMode" class="form-control">
            <option value="" disabled selected>Select payment mode</option>
            <option value="CASH" translate>Cash</option>
            <option value="CARD" translate>Card</option>
            <option value="UPI" translate>UPI</option>
          </select>
        </div>

        <div class="summary-item">
          <div class="label" translate>Discount</div>
          <input placeholder="Enter discount" (ngModelChange)="calculateTotal()" [(ngModel)]="bill.discount" class="form-control">
        </div>
        
        <div class="summary-item">
          <div class="label" translate>Advance</div>
          <input placeholder="Enter advance" (ngModelChange)="calculateTotal()" [(ngModel)]="bill.advance" class="form-control">
        </div>
        
        <div class="summary-item">
          <div class="label" translate>Grand Total</div>
          <div class="value">₹{{total - (bill.discount || 0) - (bill.advance || 0)}}</div>
        </div>
      </div>
<div class="summary-actions">
      <div class="actions">
        <mat-spinner *ngIf="loading"></mat-spinner>
        <button translate *ngIf="!bill.id" mat-raised-button class="btn btn-primary" (click)="saveBillWithItems()">
          <mat-icon>save</mat-icon> {{'Save Bill' | translate }}
        </button>
        <button translate *ngIf="bill.id" mat-raised-button class="btn btn-primary" (click)="updateBillWithItems()">
          <mat-icon>update</mat-icon> {{'Update Bill' | translate }}
        </button>
        <button translate mat-raised-button class="btn btn-secondary btn-download"  (click)="download()">
          <mat-icon>download</mat-icon> {{'Download' | translate}}
        </button>
        <button translate mat-raised-button class="btn btn-secondary btn-print" (click)="printBill()">
          <mat-icon>print</mat-icon> {{'Print' | translate }}
        </button>
          <button translate mat-raised-button class="btn btn-secondary" (click)="sendToWhatsapp()">
          <img src="whatsapp.svg" width="25px" height="25px"/> {{'Whatsapp' | translate }}
        </button>
          <button translate mat-raised-button class="btn btn-secondary" (click)="Close()">
          <mat-icon>close</mat-icon> {{'Close' | translate }}
        </button>
</div>
  <mat-progress-bar *ngIf="loading" mode="indeterminate" class="loading-bar"></mat-progress-bar>

      </div>
    </div>
  </div>
  <div class="item-select-container">
    <h3 translate>Add to Bill</h3>
   <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="filterItems()" placeholder="Search items" class="form-control mb-2">
    <div class="item-list">
      <div class ="item-card-grid" >
       <!--show selectable item cards-->
       <div *ngFor="let item of searchedItems; let i = index">

          <mat-card class="item-card" (click)="selectItem(item)">
           <div class="selected-banner" *ngIf="isItemSelected(item)">
            <mat-icon>check_circle</mat-icon>
           </div>
          <div class="stat-value">{{item.name}}</div>
          <div class="stat-label" *ngIf="item.car">Car -{{item.car}}</div>
          <div class="stat-label">Price - ₹{{item.price}}</div>
          </mat-card>
        </div>
    </div>
    <div class="form-row mt-3">
      <!-- open modal -->
      <button translate mat-raised-button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addItemModal">
        <mat-icon>add</mat-icon>{{'AddnewInventory' | translate}}
      </button>
    </div>
  </div>
  </div>
  
</div>

<div *ngIf="activeTab === 'history'">
    <mat-progress-bar *ngIf="loading" mode="indeterminate" class="loading-bar"></mat-progress-bar>

  <app-billhistory (edit)="gotoEditBill($event)" (print)="print($event)" (download)="downloadBill($event)"></app-billhistory>
</div>



<!-- Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addItemModalLabel">Add Item to Inventory</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <app-addinventory></app-addinventory>
      </div>

    </div>
  </div>
</div>
