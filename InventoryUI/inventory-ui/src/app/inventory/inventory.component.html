<div class="inventory-container">
  <mat-progress-bar *ngIf="loading" mode="indeterminate" class="loading-bar"></mat-progress-bar>

  <div class="header">
    <h1>Inventory Management</h1>
    <p class="text-secondary">Manage and track your inventory items</p>
  </div>

  <mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)" animationDuration="200ms">
    <!-- Item List Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">list</mat-icon>
        Item List
      </ng-template>

      <div class="tab-content">
        <div class="search-container">
          <div>
          <mat-form-field appearance="outline">
            <mat-icon matPrefix>search</mat-icon>
            <input matInput 
                   type="text" 
                   id="filter-text-box" 
                   placeholder="Search items..." 
                   (input)="onFilterTextBoxChanged()" />
          </mat-form-field>
          </div>
          <button *ngIf="!scanMode" mat-raised-button color="secondary" (click)="scanToUpdateInventory()" data-toggle="modal" data-target="#scanModal">
            <mat-icon>search</mat-icon>
            Scan
            </button>
          <button mat-raised-button color="secondary" (click)="downloadInventory()"><mat-icon style="margin:0px">download</mat-icon></button>
          <button mat-raised-button color="secondary" style="margin-left: 5px;" (click)="uploadInventory()"><mat-icon style="margin: 0px;">upload</mat-icon></button>
        </div>

          <ag-grid-angular 
            class="ag-theme-material"
            [rowData]="items" 
            [columnDefs]="colDefs"
            [defaultColDef]="defaultColDef"
            [rowSelection]="rowSelection"
            (rowSelected)="onRowSelected($event)"
            [pagination]="true"
            (gridReady)="onGridReady($event)">
          </ag-grid-angular>
      </div>
    </mat-tab>

    <!-- Add/Edit Item Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">{{selectedRowId ? 'edit' : 'add'}}</mat-icon>
        {{selectedRowId ? 'Edit Item' : 'New Item'}}
      </ng-template>

      <div class="tab-content">
        <mat-progress-bar *ngIf="showFormLoading" mode="indeterminate"></mat-progress-bar>

        <div class="form-card">
          <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
            <div class="form-group">
              <label for="Name">Name</label>
              <input id="Name" formControlName="Name" placeholder="Enter item name" required />
            </div>

            <div class="form-group">
              <label for="Quantity">Quantity</label>
              <input id="Quantity" type="number" formControlName="Quantity" placeholder="Enter quantity" required/>
            </div>

            <div class="form-group">
              <label for="Car">Car Model</label>
              <input id="Car" formControlName="Car" placeholder="Enter car model"/>
            </div>

            <div class="form-group">
              <label for="Description">Description</label>
              <input id="Description" formControlName="Description" placeholder="Enter description"/>
            </div>

            <div class="form-group">
              <label for="Price">Price</label>
              <input id="Price" type="number" formControlName="Price" placeholder="Enter price" required/>
            </div>
            <div class="form-group">
              <label for="Barcode">Barcode</label>
              <input id="Barcode" type="text" formControlName="Barcode" placeholder="Enter barcode" required/>
            </div>

            <div class="actions">
              <button type="button" mat-button class="btn btn-secondary" (click)="resetForm()">
                <mat-icon>refresh</mat-icon>
                Reset
              </button>
              <button type="submit" mat-raised-button class="btn btn-primary" [disabled]="!itemForm.valid">
                <mat-icon>save</mat-icon>
                {{selectedRowId ? 'Update' : 'Save'}}
              </button>
            </div>
          </form>
        </div>
      </div>
    </mat-tab>

    <!-- Stats Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">insights</mat-icon>
        Insights
      </ng-template>

      <div class="tab-content">
        <div class="stats-grid">
          <mat-card class="stat-card">
            <mat-icon class="stat-icon">inventory_2</mat-icon>
            <div class="stat-value">{{items.length}}</div>
            <div class="stat-label">Total Items</div>
            <mat-progress-bar mode="determinate" [value]="100"></mat-progress-bar>
          </mat-card>

         

          <mat-card class="stat-card">
            <mat-icon class="stat-icon">price_check</mat-icon>
            <div class="stat-value">₹{{totalInventoryValue | number:'1.0-0'}}</div>
            <div class="stat-label">Total Inventory Value</div>
          </mat-card>
          <mat-card class="stat-card">
            <mat-icon class="stat-icon">warning</mat-icon>
            <div class="stat-value">{{inventorybelowThreshold}}</div>
            <div class="stat-label">Restock Needed Inventory</div>
            <mat-progress-bar mode="determinate" [value]="(inventorybelowThreshold / items.length) * 100"></mat-progress-bar>
          </mat-card>
        </div>
      </div>
      <div class="item-below-threshold">
        <h2>Restock Needed Inventory</h2>
        <p *ngIf="inventorybelowThreshold === 0">All items are above the restock threshold</p>
        <div class="item-below-threshold-list">
        <mat-card *ngFor="let item of itembelowThreshold" class="item-card">
          <div class="item-details">
            <h3>{{item.name}}</h3>
            <p>Quantity: {{item.quantity}}</p>
            <p>Price: ₹{{item.price | number:'1.0-0'}}</p>
          </div>
          </mat-card>
          </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<div class="modal fade" id="scanmodal" tabindex="-1"role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Scanner Mode</h2>
      </div>
      <div class="modal-body">
          <p *ngIf="scannedItems.length === 0">No items scanned yet.</p>
        <p>Scan items using the barcode scanner.
          </p>
        <table *ngIf="scannedItems.length > 0" class="table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Category</th>
              <th>Car Model</th>
              <th>Quantity</th>
              <th>Price</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of scannedItems; let i = index; ">
              <td>{{item.name}}</td>
              <td>{{item.category}}</td>
              <td>{{item.car}}</td>
              <td><input type="number" [(ngModel)]="scannedItems[i].quantity" ></td>
              <td>₹{{item.price | number:'1.0-0'}}</td>
            </tr>
          </tbody>
        </table>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="exitScanner()">Save changes</button>
        <button type="button" class="btn btn-secondary"(click)="exitScanner()" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>